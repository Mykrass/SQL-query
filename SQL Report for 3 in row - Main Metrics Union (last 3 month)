/*
/*
SQL Report for 3 in row - Main Metrics Union
https://www.devtodev.com/education/articles/ru/425/sql-dlya-nachinayushtih-osnovnie-metriki-neskolykih-prilozheniy
*/

declare 
@day_interval interval = '30 day',
@payments_count int = 2,
@item_list text[] = '{"offer1", "offer2", "special offer"}',
@country text[] = array['US', 'DE', 'RU'];
 
select 'Paying users  ( for ' ||@day_interval|| ')' as "Metric"
  ,count(distinct devtodevid) as "Value"
  from p102968.payments
  where created > current_date - @day_interval and created < current_date
    and country = any (@country)

union all
  select 'Gross ( for ' ||@day_interval|| ')'
  ,round(sum(priceusd)::float, 2)
  from p102968.payments
  where eventtime > current_date - @day_interval and eventtime < current_date
    and country = any (@country)
    
    
union all
  select 'MAU'
  ,count(distinct devtodevid)
  from p102968.sessions
  where eventtime > current_date - interval '30 day' and eventtime < current_date
    and country = any (@country) 
    
union all

  select 'ARPPU  ( for ' ||@day_interval|| ')'
  --,round(daily_revenue.rev / daily_revenue.payed_users, 2) as "ARPPU"
  ,round(sum(priceusd)::float / count(distinct devtodevid), 2) 
  from p102968.payments
  where eventtime > current_date - @day_interval and eventtime < current_date
    and country = any (@country)
    
union all

  select 'ARPU  ( for ' ||@day_interval|| ')'
  ,round(daily_revenue.rev / daily_players.players, 3) as "ARPU"
  from p102968.payments
  where eventtime > current_date - @day_interval and eventtime < current_date
    and country = any (@country)
    
union all

  select 'PAYING SHARE, %  ( for ' ||@day_interval|| ')'
    ,round(100 * median("ARPU") / median("ARPPU"), 2) as "PAYING SHARE, %"
  from p102968.payments
  where eventtime > current_date - @day_interval and eventtime < current_date
    and country = any (@country)
    
order by 1 asc;
