/*
/*
SQL Report for 3 in row - CARPU on 30 days after install
*/

--declare
--@start_date date = '2023-06-01',
--@finish_date date = '2023-07-01';

--In the data CTE we add the last known value for the parameter userLevel to all the other events and bring the interesting columns into scope
--Next we group all events and the data by the last known value for the userlevel and create the aggregates we are interested in.
WITH t1 AS
  (SELECT eventtype,
          devtodevid,
          --last_value(eventlevel IGNORE NULLS) over (partition BY devtodevid
          last_value(eventlevel) over (partition BY devtodevid
                                         ORDER BY eventtype) AS current_level,
          eventtime,
          activityduration
          
   FROM p102968.sessions)
   
, t2 as(
SELECT coalesce(current_level, 0) AS "Level",--replace not known yet with level 0
        --sum(msSinceLastEvent)/1000 AS 'Seconds Spent On Level',
        sum(activityduration) AS "Seconds Spent On Level",
        count(DISTINCT devtodevid) AS "Number of users",
        count(DISTINCT eventtime) AS "Total days spent",
        count(DISTINCT eventtime)/count(DISTINCT devtodevid) AS "average days spent",
        --sum(activityduration)/count(DISTINCT devtodevid) AS "average seconds in game spent on level",
        sum(activityduration)/60/count(DISTINCT devtodevid) AS "average minutes in game spent on level"
FROM t1
GROUP BY current_level
ORDER BY current_level
)   

select * from t2 order by "Level";
