/*
/*
SQL Report for 3 in row - Shop open frequency
*/
select level
, round(100 :: numeric*"1 time" / last_value("all ads viewed") over(order by level), 2) as "1 time"
, round(100 :: numeric*"2 times" / last_value("all ads viewed") over(order by level), 2) as "2 times"
, round(100 :: numeric*"3-5 times" / last_value("all ads viewed") over(order by level), 2) as "3-5 times"
, round(100 :: numeric*"6+ times" / last_value("all ads viewed") over(order by level), 2) as "6+ times"
--, round(100 :: numeric*"all ads viewed" / first_value("all ads viewed") over(order by level), 2) as "all ads viewed"
from(
  select level
  , count(distinct devtodevid) filter(where cnt=1) as "1 time"
  , count(distinct devtodevid) filter(where cnt=2) as "2 times"
  , count(distinct devtodevid) filter(where cnt>2 and cnt<6) as "3-5 times"
  , count(distinct devtodevid) filter(where cnt>5 and cnt<11) as "6+ times"
  , count(distinct devtodevid) filter(where cnt>0 and cnt<11) as "all ads viewed"
  from(
  select devtodevid, cnt, level
  from p104704.levelups
  left join(
  select devtodevid, count() cnt
  from p104704.custom_events
  where created >= current_date - interval '7 day'
  and name = 'shop open'
  group by 1) t1 using(devtodevid)
  )t2
  where level < 9
  group by 1
  order by 1
)t3;
