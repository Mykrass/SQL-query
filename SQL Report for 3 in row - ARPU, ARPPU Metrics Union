/*
/*
SQL Report for 3 in row - ARPU, ARPPU Metrics Union
https://www.devtodev.com/education/articles/ru/425/sql-dlya-nachinayushtih-osnovnie-metriki-neskolykih-prilozheniy
*/

declare 
@day_interval interval = '30 day',
@country text[] = array['US', 'DE', 'RU'];

with t1 as(
  select eventtime::date as "dt"
    ,count(distinct devtodevid) as "payed_users"
    ,sum(priceusd) as "revenue"
  from p105094.payments 
  where eventtime > current_date - @day_interval and eventtime < current_date
  and country = any (@country)
  group by 1
  order by 1
)

,t2 as(
  select eventtime::date as "dt"
    ,count(distinct devtodevid) as "users"
  from p105094.sessions
  where eventtime > current_date - @day_interval
  and country = any (@country)
  group by 1
  order by 1
)

,t3 as(
  select dt as "Date"
      ,round(revenue/users, 2) as "ARPU"
      ,round(revenue/payed_users, 2) as "APRRU"
  from t1
  join t2
  using(dt)
)

  select 'ARPU  ( for ' ||@day_interval|| ')' as "Metric"
      ,round(avg(revenue/users), 2) as "Value"
  from t1
  join t2
  using(dt)
  
union all  
    select 'ARPPU  ( for ' ||@day_interval|| ')'  as "Metric"
      ,round(avg(revenue/payed_users), 2) as "Value"
  from t1
  join t2
  using(dt)
